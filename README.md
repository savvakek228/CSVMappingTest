Сделал в двух вариантах - синхронное составление отчетов, и асинхронное. 

Каждый вариант в соответствующей ветке. 
